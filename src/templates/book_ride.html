{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Booking Form -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Đặt xe</h5>
                </div>
                <div class="card-body">
                    <form id="booking-form">
                        <!-- Điểm đón -->
                        <div class="mb-3">
                            <label class="form-label">Điểm đón</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="pickup" placeholder="Nhập địa điểm đón">
                                <button class="btn btn-outline-secondary" type="button" id="use-current-location">
                                    <i class="fas fa-location-arrow"></i>
                                </button>
                            </div>
                            <div id="pickup-suggestions" class="list-group mt-2 d-none"></div>
                        </div>

                        <!-- Điểm đến -->
                        <div class="mb-3">
                            <label class="form-label">Điểm đến</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="dropoff" placeholder="Nhập địa điểm đến">
                                <button class="btn btn-outline-secondary" type="button" id="save-location">
                                    <i class="fas fa-bookmark"></i>
                                </button>
                            </div>
                            <div id="dropoff-suggestions" class="list-group mt-2 d-none"></div>
                        </div>

                        <!-- Thời gian -->
                        <div class="mb-3">
                            <label class="form-label">Thời gian đón (nếu muốn đặt trước)</label>
                            <div class="input-group">
                                <input type="time" class="form-control" id="pickup-time">
                                <span class="input-group-text">hoặc</span>
                                <button type="button" class="btn btn-outline-primary" id="book-now">
                                    <i class="fas fa-bolt me-1"></i>Đặt ngay
                                </button>
                            </div>
                            <small class="text-muted">Nếu không chọn thời gian, hệ thống sẽ đặt xe ngay lập tức</small>
                        </div>

                        <!-- Số hành khách -->
                        <div class="mb-3">
                            <label class="form-label">Số hành khách</label>
                            <select class="form-select" id="passengers">
                                <option value="1">1 người</option>
                                <option value="2">2 người</option>
                                <option value="3">3 người</option>
                                <option value="4">4 người</option>
                            </select>
                        </div>

                        <!-- Loại xe -->
                        <div class="mb-3">
                            <label class="form-label">Loại xe</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="card vehicle-type" data-type="standard">
                                        <div class="card-body text-center">
                                            <i class="fas fa-car fa-2x mb-2"></i>
                                            <h6>Standard</h6>
                                            <small class="text-muted">4 chỗ</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card vehicle-type" data-type="luxury">
                                        <div class="card-body text-center">
                                            <i class="fas fa-car-side fa-2x mb-2"></i>
                                            <h6>Luxury</h6>
                                            <small class="text-muted">4 chỗ</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ghi chú -->
                        <div class="mb-3">
                            <label class="form-label">Ghi chú cho tài xế</label>
                            <textarea class="form-control" id="notes" rows="2" placeholder="Nhập ghi chú (nếu có)"></textarea>
                        </div>

                        <!-- Địa điểm yêu thích -->
                        <div class="mb-3">
                            <label class="form-label">Địa điểm yêu thích</label>
                            <div id="favorites" class="list-group">
                                <!-- Sẽ được điền bởi JavaScript -->
                            </div>
                        </div>

                        <!-- Mã giảm giá -->
                        <div class="mb-3">
                            <label class="form-label">Mã giảm giá</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="promo-code" placeholder="Nhập mã giảm giá">
                                <button class="btn btn-outline-primary" type="button" id="apply-promo">Áp dụng</button>
                            </div>
                        </div>

                        <!-- Phương thức thanh toán -->
                        <div class="mb-3">
                            <label class="form-label">Phương thức thanh toán</label>
                            <div class="list-group">
                                <label class="list-group-item">
                                    <input class="form-check-input me-1" type="radio" name="payment" value="cash" checked>
                                    Tiền mặt
                                </label>
                                <label class="list-group-item">
                                    <input class="form-check-input me-1" type="radio" name="payment" value="card">
                                    Thẻ tín dụng
                                </label>
                                <label class="list-group-item">
                                    <input class="form-check-input me-1" type="radio" name="payment" value="momo">
                                    Ví MoMo
                                </label>
                            </div>
                        </div>

                        <!-- Nút đặt xe -->
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-check me-2"></i>Đặt xe
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Map and Estimate -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Bản đồ</h5>
                </div>
                <div class="card-body p-0">
                    <div class="map-container">
                        <div id="map"></div>
                        <div class="map-controls">
                            <button id="locate-me" class="btn btn-primary">
                                <i class="fas fa-location-arrow"></i> Vị trí của tôi
                            </button>
                            <button id="reset-view" class="btn btn-secondary">
                                <i class="fas fa-sync"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estimate Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Dự kiến</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <h6>Thời gian</h6>
                                <p id="estimated-time">-- phút</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="fas fa-route fa-2x mb-2"></i>
                                <h6>Quãng đường</h6>
                                <p id="estimated-distance">-- km</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                                <h6>Giá dự kiến</h6>
                                <p id="estimated-price">-- đ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.map-container {
    position: relative;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

#map {
    height: 400px;
    width: 100%;
    z-index: 1;
}

.map-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.map-controls .btn {
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
    transition: all 0.2s ease;
    border: none;
    box-shadow: 0 1px 5px rgba(0,0,0,0.4);
}

.map-controls .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
}

.vehicle-type {
    cursor: pointer;
    transition: all 0.2s ease;
}

.vehicle-type:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.vehicle-type.selected {
    border-color: var(--bs-primary);
    background-color: var(--bs-primary-bg-subtle);
}

.list-group-item {
    cursor: pointer;
}

.list-group-item:hover {
    background-color: var(--bs-primary-bg-subtle);
}

@media (max-width: 768px) {
    #map {
        height: 300px;
    }
    
    .map-controls .btn {
        padding: 6px 10px;
        font-size: 12px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map
    var map = L.map('map').setView([21.0285, 105.8542], 13); // Hanoi coordinates
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Variables for route
    var pickupMarker = null;
    var dropoffMarker = null;
    var routeLine = null;

    // Vehicle type selection
    document.querySelectorAll('.vehicle-type').forEach(function(el) {
        el.addEventListener('click', function() {
            document.querySelectorAll('.vehicle-type').forEach(function(e) {
                e.classList.remove('selected');
            });
            this.classList.add('selected');
        });
    });

    // Use current location button
    document.getElementById('use-current-location').addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Update pickup input
                document.getElementById('pickup').value = 'Vị trí hiện tại của bạn';
                
                // Update map
                if (pickupMarker) {
                    map.removeLayer(pickupMarker);
                }
                pickupMarker = L.marker([lat, lng])
                    .bindPopup('Điểm đón')
                    .addTo(map);
                
                updateRoute();
            });
        } else {
            alert('Trình duyệt của bạn không hỗ trợ định vị.');
        }
    });

    // Save location button
    document.getElementById('save-location').addEventListener('click', function() {
        const location = document.getElementById('dropoff').value;
        if (location) {
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            if (!favorites.includes(location)) {
                favorites.push(location);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                updateFavoritesList();
            }
        }
    });

    // Update favorites list
    function updateFavoritesList() {
        const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        const container = document.getElementById('favorites');
        container.innerHTML = favorites.map(fav => `
            <a href="#" class="list-group-item list-group-item-action">${fav}</a>
        `).join('');
    }

    // Initialize favorites list
    updateFavoritesList();

    // Apply promo code
    document.getElementById('apply-promo').addEventListener('click', function() {
        const code = document.getElementById('promo-code').value;
        // Add promo code logic here
        alert('Mã giảm giá đã được áp dụng!');
    });

    // Update route on map
    function updateRoute() {
        if (pickupMarker && dropoffMarker) {
            if (routeLine) {
                map.removeLayer(routeLine);
            }
            
            const pickup = pickupMarker.getLatLng();
            const dropoff = dropoffMarker.getLatLng();
            
            // Simulate route calculation
            routeLine = L.polyline([
                [pickup.lat, pickup.lng],
                [dropoff.lat, dropoff.lng]
            ], {color: 'blue'}).addTo(map);
            
            // Update estimate
            updateEstimate();
        }
    }

    // Update estimate
    function updateEstimate() {
        if (pickupMarker && dropoffMarker) {
            const pickup = pickupMarker.getLatLng();
            const dropoff = dropoffMarker.getLatLng();
            
            // Simulate distance calculation
            const distance = pickup.distanceTo(dropoff) / 1000; // Convert to km
            const time = Math.round(distance * 2); // Rough estimate: 2 minutes per km
            const price = Math.round(distance * 15000); // Rough estimate: 15k per km
            
            document.getElementById('estimated-time').textContent = time + ' phút';
            document.getElementById('estimated-distance').textContent = distance.toFixed(1) + ' km';
            document.getElementById('estimated-price').textContent = price.toLocaleString() + ' đ';
        }
    }

    // Form submission
    document.getElementById('booking-form').addEventListener('submit', function(e) {
        e.preventDefault();
        // Add booking logic here
        alert('Đặt xe thành công!');
    });

    // Locate me button
    document.getElementById('locate-me').addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                map.setView([position.coords.latitude, position.coords.longitude], 15);
                if (pickupMarker) {
                    map.removeLayer(pickupMarker);
                }
                pickupMarker = L.marker([position.coords.latitude, position.coords.longitude])
                    .bindPopup('Vị trí của bạn')
                    .addTo(map);
                updateRoute();
            });
        } else {
            alert('Trình duyệt của bạn không hỗ trợ định vị.');
        }
    });

    // Reset view button
    document.getElementById('reset-view').addEventListener('click', function() {
        map.setView([21.0285, 105.8542], 13);
    });
});
</script>
{% endblock %} 